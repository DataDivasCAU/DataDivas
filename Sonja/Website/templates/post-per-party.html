<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamische Tabelle + Tortendiagramm</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-5xl mx-auto">
    <header class="flex items-end justify-between mb-6 gap-4">
      <div>
        <h1 class="text-2xl font-bold">Posts per Party</h1>
        <div id="subtitle" class="text-sm text-gray-500 mt-1">Ansicht: 2025</div>
      </div>

      <div class="flex items-center gap-3 flex-wrap">
        <label for="dataset" class="font-medium">Wahlperiode:</label>
        <select id="dataset" class="border rounded p-2 bg-white">
          <option value="first">Wahl 2025</option>
          <option value="second">Wahl 2021</option>
          <option value="both">Beide Wahlen</option>
        </select>

        <!-- Export-Button -->
        <a id="btnExport"
           href="/export-excel"
           class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 whitespace-nowrap">
          Export als Excel
        </a>
      </div>
    </header>

    <!-- Tabelle -->
    <div class="overflow-x-auto shadow rounded-2xl mb-8 bg-white">
      <table id="partyTable" class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-100 text-left" id="tableHead"></tr>
        </thead>
        <tbody></tbody>
        <tfoot id="tableFoot"></tfoot>
      </table>
    </div>

    <!-- Chart (nur bei Single-Ansicht) -->
    <section class="max-w-xl mb-12">
      <div id="chartTitle"><b>Posts 2025 (Pie)</b></div>
      <canvas id="pieChart"></canvas>
    </section>

    <!-- Karten-Buttons -->
    <section class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Karte: Data JSON -->
      <a href="/data.json"
         class="block rounded-2xl bg-white shadow hover:shadow-lg transition transform hover:-translate-y-1 p-6">
        <h2 class="text-xl font-bold text-indigo-700 mb-2">üìÇ Daten (JSON)</h2>
        <p class="text-gray-600">Rohdaten zu Posts pro Partei als JSON.</p>
      </a>

      <!-- Karte: Election JSON -->
      <a href="/election.json"
         class="block rounded-2xl bg-white shadow hover:shadow-lg transition transform hover:-translate-y-1 p-6">
        <h2 class="text-xl font-bold text-indigo-700 mb-2">üó≥Ô∏è Wahldaten</h2>
        <p class="text-gray-600">Wahlergebnisse der Parteien in JSON-Form.</p>
      </a>

      <!-- Karte: Stats -->
      <a href="/load_yt_current_data_of_parties"
         class="block rounded-2xl bg-white shadow hover:shadow-lg transition transform hover:-translate-y-1 p-6">
        <h2 class="text-xl font-bold text-indigo-700 mb-2">üìà Stats</h2>
        <p class="text-gray-600">Lade aktuelle YouTube-Statistiken der Parteien.</p>
      </a>
    </section>
  </div>

  <script defer>
    let dataStore = {
      posts2025: [],
      posts2021: [],
      election2025: new Map(),
      election2021: new Map(),
      diffElection: new Map(),
    };

    let currentPeriod = "first";
    let chart;
    let sortState = { key: null, dir: 1 };

    const PARTY_COLORS = new Map([
      ["cdu", "#000000"], ["csu", "#000000"],
      ["spd", "#E3000F"], ["fdp", "#FFED00"],
      ["gruene", "#1AA037"], ["gr√ºne", "#1AA037"],
      ["die linke", "#BE3075"], ["linke", "#BE3075"],
      ["afd", "#009EE0"], ["bsw", "#00B3A4"],
      ["sonstige", "#9CA3AF"],
    ]);
    const norm = (p) => String(p).toLowerCase();
    const pretty = (p) => {
      const m = { gruene:"Gr√ºne", gr√ºne:"Gr√ºne", linke:"Linke",
                  cdu:"CDU", csu:"CSU", spd:"SPD", fdp:"FDP",
                  afd:"AfD", bsw:"BSW" };
      const k = norm(p);
      return m[k] || p;
    };
    const fmtPct = (v) =>
      `${(Number(v) || 0).toLocaleString("de-DE", { maximumFractionDigits: 2 })}%`;

    function getPartyColor(label) {
      const k = norm(label);
      if (PARTY_COLORS.has(k)) return PARTY_COLORS.get(k);
      if (k.includes("gruen") || k.includes("gr√ºn")) return "#1AA037";
      if (k.includes("linke")) return "#BE3075";
      if (k.includes("cdu") || k.includes("csu")) return "#000000";
      if (k.includes("spd")) return "#E3000F";
      if (k.includes("fdp")) return "#FFED00";
      if (k.includes("afd")) return "#009EE0";
      if (k.includes("bsw")) return "#00B3A4";
      return "#9CA3AF";
    }

    Promise.all([
      fetch("/data.json"),
      fetch("/election.json")
    ])
      .then(async ([pRes, eRes]) => {
        if (!pRes.ok) throw new Error(`data.json HTTP ${pRes.status}`);
        if (!eRes.ok) throw new Error(`election.json HTTP ${eRes.status}`);
        return [await pRes.json(), await eRes.json()];
      })
      .then(([postsData, electData]) => {
        const p2025 = postsData.electionPosts2025 || {};
        const p2021 = postsData.electionPosts2021 || {};
        const rows2025 = Object.entries(p2025).map(([party, posts]) => ({ party: pretty(party), posts: Number(posts)||0 }));
        const rows2021 = Object.entries(p2021).map(([party, posts]) => ({ party: pretty(party), posts: Number(posts)||0 }));

        const e25 = (electData.election2025 && electData.election2025[0]) || {};
        const e21 = (electData.election2021 && electData.election2021[0]) || {};
        const dE  = electData.diffElection || {};
        dataStore.election2025 = new Map(Object.entries(e25).map(([k,v]) => [pretty(k), Number(v)||0]));
        dataStore.election2021 = new Map(Object.entries(e21).map(([k,v]) => [pretty(k), Number(v)||0]));
        dataStore.diffElection = new Map(Object.entries(dE).map(([k,v]) => [pretty(k), Number(v)||0]));

        dataStore.posts2025 = mergeElection(rows2025, dataStore.election2025);
        dataStore.posts2021 = mergeElection(rows2021, dataStore.election2021);

        refresh();
      })
      .catch(err => console.error("Ladefehler:", err));

    function mergeElection(rows, map) {
      const parties = new Set([...rows.map(r => r.party), ...map.keys()]);
      return [...parties].map(p => {
        const r = rows.find(x => x.party === p) || { party: p, posts: 0 };
        return { party: p, posts: r.posts, electionCount: map.get(p) || 0 };
      });
    }

    function renderHeader(columns) {
      const thead = document.getElementById("tableHead");
      thead.innerHTML = "";
      columns.forEach(col => {
        const th = document.createElement("th");
        th.className = "px-4 py-2 border-b cursor-pointer select-none";
        th.dataset.sort = col.key;
        th.textContent = col.label + " " +
          (sortState.key === col.key ? (sortState.dir === 1 ? "‚ñ≤" : "‚ñº") : "‚ñ≤‚ñº");
        th.addEventListener("click", () => {
          if (sortState.key === col.key) sortState.dir *= -1;
          else { sortState.key = col.key; sortState.dir = 1; }
          refresh();
        });
        thead.appendChild(th);
      });
    }

    function renderTableSingle(rows, year) {
      renderHeader([
        { key: "party",         label: "Partei" },
        { key: "posts",         label: `Posts ${year}` },
        { key: "electionCount", label: `Election ${year} (%)` },
      ]);

      const tbody = document.querySelector("#partyTable tbody");
      const tfoot = document.getElementById("tableFoot");
      tbody.innerHTML = ""; tfoot.innerHTML = "";

      let data = rows.slice();
      if (sortState.key) {
        data.sort((a, b) => {
          const va = a[sortState.key], vb = b[sortState.key];
          if (va < vb) return -1 * sortState.dir;
          if (va > vb) return  1 * sortState.dir;
          return 0;
        });
      }

      let sumPosts = 0;
      data.forEach(row => {
        sumPosts += row.posts;
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition-colors";
        tr.innerHTML = `
          <td class="px-4 py-2 border-b font-medium">
            <span class="inline-block w-3 h-3 rounded-sm align-middle mr-2"
                  style="background:${getPartyColor(row.party)}"></span>
            ${row.party}
          </td>
          <td class="px-4 py-2 border-b">${row.posts}</td>
          <td class="px-4 py-2 border-b">${fmtPct(row.electionCount)}</td>
        `;
        tbody.appendChild(tr);
      });

      tfoot.innerHTML = `
        <tr class="bg-gray-50 font-semibold">
          <td class="px-4 py-2 border-t">Summe</td>
          <td class="px-4 py-2 border-t">${sumPosts}</td>
          <td class="px-4 py-2 border-t">‚Äî</td>
        </tr>
      `;
    }

    function renderTableBoth() {
      const p25 = new Map((dataStore.posts2025 || []).map(r => [r.party, r.posts]));
      const p21 = new Map((dataStore.posts2021 || []).map(r => [r.party, r.posts]));
      const e25 = dataStore.election2025 || new Map();
      const e21 = dataStore.election2021 || new Map();
      const dE  = dataStore.diffElection || new Map();
      const parties = [...new Set([...p25.keys(), ...p21.keys(), ...e25.keys(), ...e21.keys(), ...dE.keys()])];

      renderHeader([
        { key: "party",          label: "Partei" },
        { key: "posts2025",      label: "Posts 2025" },
        { key: "election2025",   label: "Election 2025 (%)" },
        { key: "posts2021",      label: "Posts 2021" },
        { key: "election2021",   label: "Election 2021 (%)" },
        { key: "diffPosts",      label: "Diff Posts (25‚Äì21)" },
        { key: "diffElection",   label: "Diff Election (pp)" },
      ]);

      const tbody = document.querySelector("#partyTable tbody");
      const tfoot = document.getElementById("tableFoot");
      tbody.innerHTML = ""; tfoot.innerHTML = "";

      let data = parties.map(p => {
        const v25 = p25.get(p) || 0;
        const v21 = p21.get(p) || 0;
        const e_25 = e25.get(p) || 0;
        const e_21 = e21.get(p) || 0;
        const de = dE.has(p) ? dE.get(p) : (e_25 - e_21);
        return {
          party: p,
          posts2025: v25,
          election2025: e_25,
          posts2021: v21,
          election2021: e_21,
          diffPosts: v25 - v21,
          diffElection: de
        };
      });

      if (sortState.key) {
        data.sort((a, b) => {
          const va = a[sortState.key], vb = b[sortState.key];
          if (va < vb) return -1 * sortState.dir;
          if (va > vb) return  1 * sortState.dir;
          return 0;
        });
      }

      let sum25 = 0, sum21 = 0;
      data.forEach(row => {
        sum25 += row.posts2025;
        sum21 += row.posts2021;

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition-colors";
        tr.innerHTML = `
          <td class="px-4 py-2 border-b font-medium">
            <span class="inline-block w-3 h-3 rounded-sm align-middle mr-2"
                  style="background:${getPartyColor(row.party)}"></span>
            ${row.party}
          </td>
          <td class="px-4 py-2 border-b">${row.posts2025}</td>
          <td class="px-4 py-2 border-b">${fmtPct(row.election2025)}</td>
          <td class="px-4 py-2 border-b">${row.posts2021}</td>
          <td class="px-4 py-2 border-b">${fmtPct(row.election2021)}</td>
          <td class="px-4 py-2 border-b ${row.diffPosts>=0?'text-green-700':'text-red-700'}">
            ${row.diffPosts >= 0 ? '+'+row.diffPosts : row.diffPosts}
          </td>
          <td class="px-4 py-2 border-b ${row.diffElection>=0?'text-green-700':'text-red-700'}">
            ${(row.diffElection>=0?'+':'')}${row.diffElection.toLocaleString("de-DE",{maximumFractionDigits:2})} pp
          </td>
        `;
        tbody.appendChild(tr);
      });

      const totalDiff = sum25 - sum21;

      tfoot.innerHTML = `
        <tr class="bg-gray-50 font-semibold">
          <td class="px-4 py-2 border-t">Summe</td>
          <td class="px-4 py-2 border-t">${sum25}</td>
          <td class="px-4 py-2 border-t">‚Äî</td>
          <td class="px-4 py-2 border-t">${sum21}</td>
          <td class="px-4 py-2 border-t">‚Äî</td>
          <td class="px-4 py-2 border-t ${totalDiff>=0?'text-green-700':'text-red-700'}">
            ${totalDiff>=0?'+':''}${totalDiff}
          </td>
          <td class="px-4 py-2 border-t">‚Äî</td>
        </tr>
      `;
    }

    function renderChartSingle(rows, year) {
      const ctx = document.getElementById("pieChart").getContext("2d");
      if (chart) chart.destroy();
      if (!rows || rows.length === 0) return;

      const labels = rows.map(r => r.party);
      const values = rows.map(r => r.posts);
      const total = values.reduce((a, b) => a + b, 0);
      const backgroundColor = labels.map(getPartyColor);

      chart = new Chart(ctx, {
        type: "pie",
        data: { labels, datasets: [{ data: values, backgroundColor }] },
        options: {
          plugins: {
            legend: { position: "right" },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw;
                  const percent = total ? ((value / total) * 100).toFixed(1) : "0.0";
                  return `${context.label}: ${value} (${percent}%)`;
                }
              }
            }
          }
        }
      });

      document.getElementById("chartTitle").innerHTML = `<b>Posts ${year} (Pie)</b>`;
    }

    function refresh() {
      const subtitle = document.getElementById("subtitle");
      if (currentPeriod === "both") {
        subtitle.textContent = "Ansicht: 2025 vs. 2021";
        renderTableBoth();
        if (chart) chart.destroy();
        document.getElementById("chartTitle").innerHTML = "<b>‚Äî</b>";
        return;
      }

      if (currentPeriod === "first") {
        subtitle.textContent = "Ansicht: 2025";
        renderTableSingle(dataStore.posts2025, 2025);
        renderChartSingle(dataStore.posts2025, 2025);
      } else {
        subtitle.textContent = "Ansicht: 2021";
        renderTableSingle(dataStore.posts2021, 2021);
        renderChartSingle(dataStore.posts2021, 2021);
      }
    }

    document.getElementById("dataset").addEventListener("change", (e) => {
      const v = e.target.value;
      currentPeriod = (v === "both") ? "both" : (v === "second" ? "second" : "first");
      refresh();
    });
  </script>
</body>
</html>
