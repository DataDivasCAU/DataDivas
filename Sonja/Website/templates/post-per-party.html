<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamische Tabelle + Tortendiagramm</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-5xl mx-auto">
    <header class="flex items-end justify-between mb-6 gap-4">
      <h1 class="text-2xl font-bold">Posts per Party</h1>

      <div class="flex items-center gap-3">
        <label for="dataset" class="font-medium">Wahlperiode:</label>
        <select id="dataset" class="border rounded p-2 bg-white">
          <option value="firstElection">Wahl 2025</option>
          <option value="secondElection">Wahl 2021</option>
          <option value="both">Beide Wahlen</option>
        </select>

        <!-- API-Export -->
        <a id="btnExport"
           href="{{ url_for('export_excel') }}"
           class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 whitespace-nowrap">
          Export als Excel
        </a>
      </div>
    </header>

    <!-- Tabelle -->
    <div class="overflow-x-auto shadow rounded-2xl mb-8 bg-white">
      <table id="partyTable" class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-100 text-left" id="tableHead"></tr>
        </thead>
        <tbody></tbody>
        <tfoot id="tableFoot"></tfoot>
      </table>
    </div>

    <!-- Chart -->
    <section class="max-w-xl">
      <canvas id="pieChart"></canvas>
    </section>
  </div>

  <script defer>
    let json = {};
    let currentPeriod = "firstElection"; // firstElection | secondElection | both
    let chart;
    let sortState = { key: null, dir: 1 }; // 1 = asc, -1 = desc

    // === Parteifarben ===
    const PARTY_COLORS = new Map([
      ["cdu", "#000000"], ["csu", "#000000"],
      ["spd", "#E3000F"],
      ["fdp", "#FFED00"],
      ["gruene", "#1AA037"], ["grüne", "#1AA037"],
      ["die linke", "#BE3075"], ["linke", "#BE3075"],
      ["afd", "#009EE0"],
      ["bsw", "#00B3A4"],
      ["sonstige", "#9CA3AF"],
    ]);

    const norm = (p) => String(p).toLowerCase();
    const pretty = (p) => {
      const m = {
        gruene: "Grüne", grüne: "Grüne", linke: "Linke",
        cdu: "CDU", csu: "CSU", spd: "SPD", fdp: "FDP",
        afd: "AfD", bsw: "BSW"
      };
      const k = norm(p);
      return m[k] || p;
    };

    const fmtPct = (v) =>
      `${(Number(v) || 0).toLocaleString("de-DE", { maximumFractionDigits: 2 })}%`;

    function getPartyColor(label) {
      const k = norm(label);
      if (PARTY_COLORS.has(k)) return PARTY_COLORS.get(k);
      if (k.includes("gruen") || k.includes("grün")) return "#1AA037";
      if (k.includes("linke")) return "#BE3075";
      if (k.includes("cdu") || k.includes("csu")) return "#000000";
      if (k.includes("spd")) return "#E3000F";
      if (k.includes("fdp")) return "#FFED00";
      if (k.includes("afd")) return "#009EE0";
      if (k.includes("bsw")) return "#00B3A4";
      return "#9CA3AF";
    }

    // ---- Helpers für neues Format ----
    function objectToRows(obj) {
      // { "CDU": 712, "CSU": 275, ... } -> [{party:"CDU", posts:712}, ...]
      if (!obj || typeof obj !== "object") return [];
      return Object.entries(obj).map(([k, v]) => ({
        party: pretty(k),
        posts: Number(v) || 0
      }));
    }

    // ---- Daten laden: Posts + Stimmen (über Flask-Routen) ----
    Promise.all([
      fetch("/data.json"),
      fetch("/election.json")
    ])
      .then(async ([pRes, eRes]) => {
        if (!pRes.ok) throw new Error(`data.json HTTP ${pRes.status}`);
        if (!eRes.ok) throw new Error(`election.json HTTP ${eRes.status}`);
        return [await pRes.json(), await eRes.json()];
      })
      .then(([postsData, electData]) => {
        // Posts können als Array ODER Objekt kommen
        const fP = postsData.firstElection;
        const sP = postsData.secondElection;

        json.firstElection  = Array.isArray(fP)
          ? (fP || []).map(r => ({ party: pretty(r.party), posts: Number(r.posts) || 0 }))
          : objectToRows(fP);

        json.secondElection = Array.isArray(sP)
          ? (sP || []).map(r => ({ party: pretty(r.party), posts: Number(r.posts) || 0 }))
          : objectToRows(sP);

        // Optional: diffPost mitladen (für spätere Nutzung)
        json.diffPostRows = postsData.diffPost ? objectToRows(postsData.diffPost) : [];

        // Stimmen (Prozente) -> Maps Partei -> Prozent
        const e25 = (electData.election2025 && electData.election2025[0]) || {};
        const e21 = (electData.election2021 && electData.election2021[0]) || {};
        json.electionMap = {
          first:  new Map(Object.entries(e25).map(([k, v]) => [pretty(k), Number(v) || 0])),
          second: new Map(Object.entries(e21).map(([k, v]) => [pretty(k), Number(v) || 0])),
        };

        // electionCount in die Zeilen mergen
        json.firstElection  = addElectionCount(json.firstElection,  json.electionMap.first);
        json.secondElection = addElectionCount(json.secondElection, json.electionMap.second);

        refresh();
      })
      .catch(err => console.error("Ladefehler:", err));

    function addElectionCount(rows, map) {
      const parties = new Set([...rows.map(r => r.party), ...map.keys()]);
      return [...parties].map(p => {
        const r = rows.find(x => x.party === p) || { party: p, posts: 0 };
        return { party: p, posts: r.posts, electionCount: map.get(p) || 0 };
      });
    }

    // Tabellenkopf mit Sortierung
    function renderHeader(columns) {
      const thead = document.getElementById("tableHead");
      thead.innerHTML = "";
      columns.forEach(col => {
        const th = document.createElement("th");
        th.className = "px-4 py-2 border-b cursor-pointer select-none";
        th.dataset.sort = col.key;
        th.textContent = col.label + " " +
          (sortState.key === col.key ? (sortState.dir === 1 ? "▲" : "▼") : "▲▼");
        th.addEventListener("click", () => {
          if (sortState.key === col.key) {
            sortState.dir *= -1;
          } else {
            sortState.key = col.key;
            sortState.dir = 1;
          }
          refresh();
        });
        thead.appendChild(th);
      });
    }

    function renderTable(rows) {
      const tbody = document.querySelector("#partyTable tbody");
      const tfoot = document.getElementById("tableFoot");
      tbody.innerHTML = "";
      tfoot.innerHTML = "";

      if (currentPeriod === "both") {
        const p1 = new Map((json.firstElection  || []).map(r => [r.party, r.posts]));
        const p2 = new Map((json.secondElection || []).map(r => [r.party, r.posts]));
        const e1 = json.electionMap?.first  || new Map();
        const e2 = json.electionMap?.second || new Map();
        const parties = [...new Set([...p1.keys(), ...p2.keys(), ...e1.keys(), ...e2.keys()])];

        renderHeader([
          { key: "party",          label: "Partei" },
          { key: "firstPosts",     label: "First Posts" },
          { key: "firstElection",  label: "First Election (%)" },
          { key: "secondPosts",    label: "Second Posts" },
          { key: "secondElection", label: "Second Election (%)" },
        ]);

        let data = parties.map(p => ({
          party: p,
          firstPosts:     p1.get(p) || 0,
          firstElection:  e1.get(p) || 0,
          secondPosts:    p2.get(p) || 0,
          secondElection: e2.get(p) || 0,
        }));

        if (sortState.key) {
          data.sort((a, b) => {
            const va = a[sortState.key], vb = b[sortState.key];
            if (va < vb) return -1 * sortState.dir;
            if (va > vb) return  1 * sortState.dir;
            return 0;
          });
        }

        let sumFirstPosts = 0, sumSecondPosts = 0;
        data.forEach(row => {
          sumFirstPosts  += row.firstPosts;
          sumSecondPosts += row.secondPosts;

          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50 transition-colors";
          tr.innerHTML = `
            <td class="px-4 py-2 border-b font-medium">
              <span class="inline-block w-3 h-3 rounded-sm align-middle mr-2"
                    style="background:${getPartyColor(row.party)}"></span>
              ${row.party}
            </td>
            <td class="px-4 py-2 border-b">${row.firstPosts}</td>
            <td class="px-4 py-2 border-b">${fmtPct(row.firstElection)}</td>
            <td class="px-4 py-2 border-b">${row.secondPosts}</td>
            <td class="px-4 py-2 border-b">${fmtPct(row.secondElection)}</td>
          `;
          tbody.appendChild(tr);
        });

        tfoot.innerHTML = `
          <tr class="bg-gray-50 font-semibold">
            <td class="px-4 py-2 border-t">Summe</td>
            <td class="px-4 py-2 border-t">${sumFirstPosts}</td>
            <td class="px-4 py-2 border-t">—</td>
            <td class="px-4 py-2 border-t">${sumSecondPosts}</td>
            <td class="px-4 py-2 border-t">—</td>
          </tr>
        `;
        return;
      }

      // Single-Periode
      if (!rows || rows.length === 0) {
        renderHeader([{ key: "none", label: "Keine Daten verfügbar" }]);
        return;
      }

      renderHeader([
        { key: "party",         label: "Partei" },
        { key: "posts",         label: "Posts" },
        { key: "electionCount", label: "Election (%)" },
      ]);

      let data = rows.slice();
      if (sortState.key) {
        data.sort((a, b) => {
          const va = a[sortState.key], vb = b[sortState.key];
          if (va < vb) return -1 * sortState.dir;
          if (va > vb) return  1 * sortState.dir;
          return 0;
        });
      }

      let sumPosts = 0;
      data.forEach(row => {
        sumPosts += row.posts;

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition-colors";
        tr.innerHTML = `
          <td class="px-4 py-2 border-b font-medium">
            <span class="inline-block w-3 h-3 rounded-sm align-middle mr-2"
                  style="background:${getPartyColor(row.party)}"></span>
            ${row.party}
          </td>
          <td class="px-4 py-2 border-b">${row.posts}</td>
          <td class="px-4 py-2 border-b">${fmtPct(row.electionCount)}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("tableFoot").innerHTML = `
        <tr class="bg-gray-50 font-semibold">
          <td class="px-4 py-2 border-t">Summe</td>
          <td class="px-4 py-2 border-t">${sumPosts}</td>
          <td class="px-4 py-2 border-t">—</td>
        </tr>
      `;
    }

    function renderChart(rows) {
      const ctx = document.getElementById("pieChart").getContext("2d");
      if (chart) chart.destroy();
      if (currentPeriod === "both" || !rows || rows.length === 0) return;

      const labels = rows.map(r => r.party);
      const values = rows.map(r => r.posts);
      const total = values.reduce((a, b) => a + b, 0);
      const backgroundColor = labels.map(getPartyColor);

      chart = new Chart(ctx, {
        type: "pie",
        data: { labels, datasets: [{ data: values, backgroundColor }] },
        options: {
          plugins: {
            legend: { position: "right" },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw;
                  const percent = total ? ((value / total) * 100).toFixed(1) : "0.0";
                  return `${context.label}: ${value} (${percent}%)`;
                }
              }
            }
          }
        }
      });
    }

    function refresh() {
      if (currentPeriod === "both") {
        renderTable([]);
        renderChart([]);
      } else {
        const rows = json[currentPeriod] || [];
        renderTable(rows);
        renderChart(rows);
      }
    }

    // UI-Event
    document.getElementById("dataset").addEventListener("change", (e) => {
      currentPeriod = e.target.value;
      refresh();
    });

    // Export-Link: lädt die Datei direkt von der API
    document.getElementById("btnExport").addEventListener("click", () => {});
  </script>
</body>
</html>
